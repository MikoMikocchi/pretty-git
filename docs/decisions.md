# Архитектурные решения (ADR)

Версия: 0.1
Статус: Accepted (2025-08-12)

## DR-001: Формат CSV
- Плоские таблицы на отчёт. Без вложенных структур.
- Заголовок всегда присутствует.
- Кодировка UTF-8.
- Разделитель запятая, экранирование по RFC 4180.
- Пустые значения — пустая ячейка (без `null`).
- Колонки фиксированы и перечислены в `docs/output_formats.md` для каждого отчёта.

## DR-002: Windows поддержка
- Статус: best-effort для v1. Основные цели — macOS/Linux.
- Запуск через Git Bash/WSL допустим.
- Цвета отключаем по `--no-color` и при отсутствии TTY.
- Аккуратное квотирование аргументов к `git`, нормализация путей.

## DR-003: Источник данных
- v1 — системный `git` CLI. Провайдер абстрагирован для возможного добавления `RuggedProvider` позже.
- Техдолг: провести бенчмарк CLI vs Rugged на больших репозиториях перед v1.1.

## DR-004: Лимиты топов
- `--limit` по умолчанию 10.
- `--limit 0` или `--limit all` трактуется как «без ограничения».
- Стабильная сортировка: по изменениям (desc), затем по коммитам (desc), затем лексикографически.

## DR-005: Даты и время
- Ввод: ISO8601 и короткий `YYYY-MM-DD`.
- Если tz отсутствует — трактуем как локальную зону пользователя и конвертируем в UTC.
- Вывод: всегда ISO8601 UTC.

## DR-006: Ветки и фильтры
- По умолчанию используется текущая ветка.
- Повторяемые `--branch` объединяются (union) без дублей коммитов.
- Пути `--path`/`--exclude-path` применяются на уровне `git log -- <paths>` и постфильтра numstat.

## DR-007: Детерминированность
- Детерминированный порядок элементов во всех отчётах и экспортах.
- JSON/YAML/XML: стабильно отсортированные массивы.
- CSV/Markdown: стабильно отсортированные строки.

## DR-008: Производительность
- Потоковый парсинг `git log --numstat`.
- Ленивая обработка через Enumerator.
- Возможный `--progress` как улучшение в v1.1.

## DR-009: Определение языков для отчёта `languages`
- Источник соответствия расширений → язык → цвет: собственная карта, основанная на GitHub Linguist (упрощённая, локальная).
- Исключения по умолчанию: `vendor/`, `node_modules/`, `tmp/`, `log/`, `.git/`, `bin/binstubs/`, Python кэши (`__pycache__/`, `.tox/`, `.venv/`, `venv/` и др.).
- JSON и крупные data‑файлы не учитываются как язык (чтобы не искажать картину кода).
- Подсчёт: по байтам файлов; процент = `bytes / sum(bytes) * 100`, округление до 2 знаков.
- Сортировка: `bytes desc`, затем `language asc`. Лимит регулируется `--limit` (0|all — без ограничения).

## DR-010: Темы консоли и ширина терминала
- Опции тем: `basic|bright|mono`.
- Авто‑детект ширины терминала; мягкая обрезка длинных путей и колонок.
- Подсветка максимальных значений (жирное/яркое) в таблицах.
- Цвета отключаются через `--no-color` и при отсутствии TTY (Windows — best‑effort).

## DR-011: Политика автоматизации релизов
- Релизы инициируются аннотированным тегом `vX.Y.Z`.
- CI guard: проверка совпадения версии тега и версии в `lib/pretty_git/version.rb` и gemspec.
- Публикация на RubyGems выполняется только если версия ещё не существует (идемпотентность).
- После публикации создаётся PR в Homebrew tap с обновлением `url`, `sha256`, при необходимости `revision`.
- Все секреты/токены хранятся в GitHub Secrets; workflow не раскрывает их в логах.

## DR-012: Инкрементальный анализ и хранение состояния
- Стратегия: анализируются только новые коммиты относительно последнего обработанного `HEAD`.
- Формат состояния: файл в репозитории проекта пользователя (по умолчанию `.prettygit.state`) или путь из `--state-file`.
- Содержимое: `head_sha`, временные метки последнего запуска, контрольная сумма параметров фильтров.
- Инвалидация: смена `HEAD` или параметров фильтрации → полное переобнуление кэша/инкремента.
- Безопасность: файл state не включается в артефакты отчётов, не влияет на детерминизм вывода.

## DR-013: Провайдеры данных: CLI vs Rugged
- По умолчанию: системный `git` CLI (надёжность, совместимость).
- Опционально: `Rugged` под флагом `--provider rugged` для бенчмаркинга и больших репозиториев.
- Критерии выбора: производительность, потребление памяти, совместимость с фильтрами.
- Fallback: при ошибке Rugged → автоматический переход на CLI с предупреждением в stderr.

## DR-014: Hotspots и Churn
- Hotspots = нормализованная метрика (частота изменений × размер диффов) за окно времени.
- Churn = изменчивость файлов/папок за период (rolling window с конфигурируемой длиной).
- Нормализация: min-max по корпусу окна, пороги визуализации на консоли/HTML.
- Детерминизм: стабильная сортировка и фиксированная схема экспортов.

## DR-015: Ownership (владение файлами)
- Метод: аппроксимация вклада по коммитам/строкам (best-effort), конфигурируемая стратегия.
- Ограничения: нет точного blame до строки; оценка по diff-статистике и авторам.
- Вывод: доли по авторам, лидер(ы) владения, неизвестные/генерируемые файлы исключаются.

## DR-016: Плагины
- Контракт: интерфейсы для экспортёров/рендеров/провайдеров и lifecycle-hooks.
- Загрузка: по имени класса/gem с белым списком; запрет eval/небезопасных require.
- Изоляция: отсутствие сетевых вызовов по умолчанию; доступ к ФС — только чтение.

## DR-017: Конфигурация `.prettygit.yml`
- Приоритеты: CLI флаги > переменные окружения > `.prettygit.yml` > значения по умолчанию.
- Валидация: строгая, с понятными сообщениями и примерами.
- Предустановленные пресеты отчётов и параметров (например, corporate defaults).

## DR-018: HTML-экспорт
- Формат: статические HTML+CSS+JS без сервера; один архив/каталог.
- Зависимости: без рантайм-загрузки из сети; всё локально.
- Цели: интерактивные таблицы/графики, фильтры и подсветка hotspots/churn.

## DR-019: Опциональные внешние API (GitHub/GitLab)
- Строго opt-in через флаги и/или конфиг, с явной передачей токенов.
- Rate-limit и ретраи; graceful degradation при ошибках.
- Данные API не влияют на детерминизм базовых отчётов, а добавляются как дополнительные поля.
