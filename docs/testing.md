# Стратегия тестирования (Testing Strategy)

Версия: 0.1
Статус: Draft (внутренний документ)

## Цели
- Подтвердить детерминизм и корректность агрегаций/экспортов.
- Сократить регрессии форматов (JSON/CSV/YAML/XML/Markdown/console).
- Зафиксировать производительность и не допускать деградаций.

## Уровни тестов
- **Unit**: чистые функции, форматтеры, сортировки, утилиты, парсеры.
- **Service/Integration**: `PrettyGit::App`, провайдер данных (git CLI), пайплайн агрегаций.
- **CLI**: опции/валидация, ошибки, `--out`, темы, ширина терминала, exit codes.
- **Exporter**: сериализация каждого отчёта во все форматы по эталонам.
- **Snapshot**: стабильность представлений (console/markdown/xml/yaml/json) на фикс. фикстурах.
- **E2E (опционально)**: запуск против небольшого тестового git‑репозитория.

## Покрытие
- Цель: ≥ 90% для критических путей (агрегации, сортировки, экспортеры, CLI входные точки).
- Стратегия: минимизировать ложные срабатывания — игнорировать биновую обвязку и генерируемые файлы.

## Детерминизм
- Политика, тайбрейки и сортировки: см. `docs/determinism.md`.
- Контроль: снапшоты + сравнение хешей артефактов; фиксация источников времени/локали в тестах.

## Property-based тесты
- Цели: проверить инварианты агрегаций/сортировок на широком пространстве входов.
- Инструменты: fast_check аналоги для Ruby (например, `rantly`/`prop_check`) — опционально; можно писать генераторы вручную.
- Базовые инварианты:
  - Конкатенация несмещённых временных окон для `activity` равна результату по объединённому окну.
  - Для `churn` `churn = additions + deletions` для каждого элемента.
  - Для `hotspots` `score` монотонно невозрастает при сортировке; равные `score` уважают тайбрейки.
  - Для `ownership` `sum(author_shares) ≈ 100%` с учетом округлений.
  - Для `languages` `sum(bytes_i) = totals.bytes` и проценты совпадают с округлением.
- Генераторы:
  - Истории коммитов: случайные авторы, файлы, добавления/удаления, временные метки в допустимых границах.
  - Пути: включать Unicode/NFC/NFD, длинные сегменты, разные расширения.
  - Фильтры: случайные `--since/--until`, `--branch`, include/exclude path.

## Golden files (снапшоты)
- Храним эталоны для всех отчётов × форматов × лимитов на фиксированных фикстурах.
- Политика обновления: только осознанно через отдельный коммит/PR, с описанием причин в CHANGELOG.
- `generated_at` и нестабильные поля выравниваются/мокируются перед сравнением.
- Порядок массивов фиксируется правилами из `docs/determinism.md`.

### Запуск и обновление golden-тестов

```bash
# прогон только golden-спеков
bundle exec rake spec:golden

# обновление эталонных файлов (осознанно, в отдельном коммите)
UPDATE_GOLDEN=1 bundle exec rake spec:golden
```

Примечания:
- Обновление работает через переменную окружения `UPDATE_GOLDEN=1` (см. `spec/support/golden_helper.rb`).
- Для XML сравнение нормализует завершающие переводы строки/пробелы.
- После обновления обязательно просматривайте diff и фиксируйте изменения в `CHANGELOG.md`.

## CI интеграция
- Матрица снапшотов: прогон на Linux и macOS; Windows — smoke.
- Job property-based: nightly/cron, ограничение по времени, сохранение сида в артефактах.

## Валидации форматов
- Источник схем: `docs/export_schemas/` (JSON Schema/XSD); подробности структур — `docs/output_formats.md`.
- **JSON/YAML/XML**: структурное сравнение + сортировка массивов.
- **CSV**: RFC 4180, UTF‑8 без BOM, корректные заголовки, экранирование; DR‑001.
- **Markdown/console**: текстовые снапшоты; детект ширины терминала мокируется.

## Производительность
- Бенчмарк набора операций на больших фикстурах (генеративные истории коммитов).
- KPI: Time‑to‑report baseline, целевые −30% (0.2.0), −50% (0.3.0).
- Порог‑алерты: падение >10% — отметка как performance regression, отдельный label.

## Homebrew smoke‑тесты
- Проверка установки формулы из PR, запуск `pretty-git --version` и простого отчёта.
- Проверка наличия зависимостей и корректного `sha256`.

## Матрица CI
- **Руби**: 3.4.x (минимум/максимум патч‑версии).
- **ОС**: macOS, Ubuntu; Windows — best‑effort (минимальный набор).
- **Jobs**: RuboCop, RSpec, Integration (exporters), Performance (cron/nightly), Release Guard. См. `docs/release.md` (preflight) и `docs/roadmap.md` (критерии качества).

## Фикстуры
- Небольшие синтетические репозитории с контролируемой историей (скрипт генерации).
- Данные для `languages` с файлами разных языков, исключениями и большими JSON.

## Правила
- Каждая новая фича → тесты до/во время реализации (spec‑driven).
- Снапшоты обновляются только осознанно (ревью diff), с пометкой в CHANGELOG.
- Тесты должны быть читабельны, без «магии» — явные фикстуры/ожидания.
