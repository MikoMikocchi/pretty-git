# План работ и задачи (Spec-Driven)

Версия: 0.1
Статус: Draft

## Итерация 0 — Проектирование
- [x] Утвердить `requirements.md` (область, функционал, критерии приёмки)
- [x] Утвердить `cli_spec.md` (аргументы, примеры, ошибки)
- [x] Утвердить `output_formats.md` (структуры данных для экспорта)
- [x] Утвердить `data_model.md` (источник данных: git CLI vs Rugged)
 - [x] Зафиксировать ADR в `docs/decisions.md` (DR-001..DR-008)

## Итерация 1 — Скелет проекта
- [x] Инициализация gem-проекта (`pretty-git`): структура, gemspec, version
- [x] Подключить RSpec, RuboCop, стандартные конфиги
- [x] Реализовать CLI каркас (`bin/pretty-git`, `--help`, `--version`)
- [x] Базовая валидация репозитория и ошибок

## Итерация 2 — Доступ к данным Git
- [x] Реализация провайдера данных (см. `data_model.md`):
  - [x] Получение лога коммитов с полями: sha, author_name, author_email, date, message, stats (+/-), files
  - [x] Фильтры: время, автор, ветка, путь; потоковая обработка
- [x] Юнит-тесты провайдера данных

## Итерация 3 — Агрегация и аналитика
- [x] Сервисы агрегации:
  - [x] Сводка репозитория
  - [x] Активность по времени (день/неделя/месяц)
  - [x] По авторам
  - [x] По файлам/директориям
  - [x] Тепловая карта (час x день)
- [x] Тесты агрегаторов (summary/activity/authors/files)
- [x] Тесты тепловой карты и проверок фильтров для неё

## Итерация 4 — Форматирование и вывод
- [x] Консольный рендерер: заголовки, таблицы, цвета
- [x] Экспортёр: CSV
- [x] Экспортёры: Markdown, YAML (единый интерфейс)
- [x] Экспортёр: XML (единый интерфейс)
- [x] `--out` в файл и stdout по умолчанию
- [x] Интеграционные тесты на соответствие `output_formats.md`
  - [x] Проверка детерминированности порядка элементов для одинаковых входов
  - [x] Проверка CSV по правилам DR-001 (UTF-8, RFC 4180, заголовки)

## Итерация 5 — Полировка
- [ ] Улучшение производительности на больших репозиториях
- [x] Стабильные сообщения об ошибках и коды возврата
- [x] Документация: `README.md` с примерами, FAQ
- [x] Релиз 0.1.0 (gem)

## Итерация 6 — Автоматизация релиза 0.1.1
- [x] Workflow `.github/workflows/release.yml` для публикации на RubyGems
- [x] Автоматическое создание PR в Homebrew tap (обновление url/sha256, bump revision)
- [x] Guard: проверка совпадения версии тега и версии гема
- [x] Идемпотентность: пропуск `gem push`, если версия уже опубликована
- [x] Обновление `CONTRIBUTING.md` релиз‑плейбуком и `README*` (инструкция установки, бейджи)

## Итерация 7 — v0.1.3: Новые отчёты (hotspots, churn, ownership)
- [x] Скаффолдинг и интеграция отчётов в `PrettyGit::App`/CLI/Console
- [x] Реализация `hotspots`: алгоритм score, сортировка, limit; юнит‑тесты (`spec/analytics/hotspots_spec.rb`)
- [x] Реализация `churn`: алгоритм churn, сортировка, limit; юнит‑тесты (`spec/analytics/churn_spec.rb`)
- [x] Реализация `ownership`: алгоритм owner/owner_share, сортировка, limit; юнит‑тесты (`spec/analytics/ownership_spec.rb`)
- [x] Обновить спецификации: `docs/cli_spec.md`, `docs/output_formats.md`, `docs/requirements.md`
- [x] Интеграционные тесты экспорта для новых отчётов (CSV/MD/YAML/XML): детерминизм, соответствие схемам
- [x] Обновить `README.md` и `README.ru.md`: добавить описания и примеры для `hotspots`, `churn`, `ownership`
- [x] Проверить прохождение всех фильтров и параметров (`--limit`, `--out`, темы консоли) для новых отчётов

## Итерация 8 — v0.1.4: Документация и интеграции экспортов

- [x] Экспорт: интеграционные тесты для `hotspots`, `churn`, `ownership` во все форматы (CSV/Markdown/YAML/XML)
  - [x] Детерминированность порядка элементов (см. `docs/determinism.md`)
  - [x] Валидировать примеры против схем (`docs/export_schemas/json/*.schema.json`, `docs/export_schemas/xml/*.xsd`)
  - [x] Обновить/добавить примеры в `docs/examples/{json,xml}/` при необходимости
- [x] CLI/UX: проверка флагов и ошибок
  - [x] `--limit` (число и `all`), корректные сообщения об ошибках и коды возврата
  - [x] `--out` (запись в файл, существующие пути, ошибки доступа)
  - [x] Темы консоли (`--theme`) — покрыто; выравнивание/ширина терминала (моки) — TODO
- [x] Документация: публичные `README.md`/`README.ru.md`
  - [x] Разделы и примеры использования для `hotspots`, `churn`, `ownership`
  - [x] Ссылки на форматы/экспорты, краткие примеры команд
- [ ] Качество и линты
  - [x] `rake lint:markdown` (mdl с локальным `.mdlrc`) зелёный
  - [x] Link checker (`lychee`) по `docs/**` зелёный
- [x] Релизная подготовка
  - [x] Обновить `CHANGELOG.md`: `## [0.1.4] - 2025-08-14` (Fixed/Changed)
  - [x] Обновить версию в `lib/pretty_git/version.rb` → `0.1.4`
  - [x] Preflight по `docs/release.md` (CI зелёный, Guard версии, Gemfile.lock)

## Итерация 9 — v0.1.5: Стабилизация 0.1.x

- [ ] Производительность (baseline)
  - [ ] Профилирование провайдера git и агрегаторов на больших фикстурах
  - [ ] Снижение аллокаций, буферизация IO, мелкие оптимизации
- [ ] Совместимость и надёжность
  - [x] Централизованный логгер (`PrettyGit::Logger`) для verbose (stderr)
  - [x] Вынесение парсинга времени в `Utils::TimeUtils`, покрытие тестами
  - [x] Нормализация путей (Unicode NFC) в фильтрах путей/глобов
  - [x] Тесты CRLF (Windows line endings) для парсинга git log/numstat
  - [x] Документация ограничений Windows и CRLF-совместимости
  - [ ] Smoke на Windows (best‑effort)
- [ ] UX CLI
  - [x] Предупреждения при `--theme`/`--no-color` с не‑консольными форматами
  - [ ] Улучшить `--help` (структура, примеры), консистентные тексты ошибок
  - [ ] Базовое автодополнение (скрипт генерации; подготовка, если решим включать)
- [ ] CI/Release hygiene
  - [ ] Smoke для Homebrew formula (установка и простой отчёт)
  - [ ] Проверки стабильности снапшотов (golden files) для ключевых отчётов

## Итерация 10 — v0.2.0: Производительность и инкрементальность

- [ ] Провайдер `Rugged` под флагом (fallback на git CLI)
  - [ ] ADR/критерии выбора, совместимость вывода
  - [ ] Бенчмарки против git CLI, пороги деградаций
- [ ] Инкрементальный режим
  - [ ] Хранение состояния (hash `HEAD`, фильтры), анализ только новых коммитов
  - [ ] CLI‑флаги для управления инкрементальностью, документация
- [ ] Параллельные агрегации, где безопасно (по чанкам), контроль порядка результатов
- [ ] Кэширование промежуточных результатов (опционально, TTL/инвалидация по `HEAD` и фильтрам)
- [ ] Детерминизм и совместимость
  - [ ] Единые тайбрейки/сортировки во всех отчётах + интеграционные тесты стабильности
  - [ ] Нормализация TZ/локалей → единый ISO8601 UTC в экспортах
  - [ ] Обновление схем/правил эволюции форматов при необходимости

## Архитектура (высокоуровнево)
- Слои:
  - CLI (`bin/pretty-git`, `PrettyGit::CLI`)
  - Приложение/Use-cases (`PrettyGit::App`): парсинг опций → запрос данных → агрегация → рендер
  - Провайдер Git-данных (`PrettyGit::Git::Provider`)
  - Агрегаторы/Сервисы (`PrettyGit::Analytics::*`)
  - Рендеры/Экспортеры (`PrettyGit::Render::*`)
  - Общие типы/модели (`PrettyGit::Types`)

## Критерии готовности релиза 0.1.0
- Все отчёты соответствуют требованиям v1
- CLI стабильна и покрыта тестами
- Экспорты валидны и проверены тестами
- Стиль кода: RuboCop без ошибок (или документированные исключения)
 - Детерминированный вывод и корректный CSV согласно ADR

## Критерии готовности релиза 0.1.1
- Настроен и задокументирован автоматический релизный пайплайн
- Публикация гема подтверждена (ручная/CI), Homebrew tap PR создаётся автоматически
- Повторный запуск пайплайна не ломает релиз (идемпотентность проверок)

## Техдолг / После 0.1.0
- Бенчмарк git CLI vs Rugged на больших репозиториях; оценка перехода на Rugged Provider (DR-003)
 - Доп. оптимизации производительности на больших репозиториях
 - Улучшение UX консоли (автопрокрутка/секции), опциональный `--progress`
 - Доработка Homebrew automation (автотест формулы, поддержка нескольких taps)
