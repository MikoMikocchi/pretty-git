# Производительность

Статус: Draft

## Цели/бюджеты (ориентиры)
- N=50k коммитов: summary/authors < 5s на обычном ноутбуке.
- Files на 100k файловых изменений < 7s.

### KPI по версиям
- 0.2.x: −30% к базовой 0.1.x по TTR (Time‑to‑Report) на средних датасетах.
- 0.3.x: −50% к базовой 0.1.x.

## Датасеты (эталоны)
- Small: 1–2k коммитов, 5–10 авторов, моно‑репо.
- Medium: 20–50k коммитов, 30–80 авторов, умеренная история переездов/переименований.
- Large: 100k+ коммитов, монорепо/многоязычные, большие numstat.
- Для каждого: фиксированная ревизия (SHA) и сценарии CLI (reports × filters × formats).

## Методика бенчмарков
- Набор эталонных репозиториев (OSS, частные зеркала), фиксированные ревизии.
- Прогрев, 3 прогона, медиана.
- Инструменты: `stackprof`, `memory_profiler`, `benchmark/ips`.

### Метрики
- Время до первого байта (TTFB) для console/streaming форматов.
- Полное время генерации (TTR) для всех форматов.
- Пиковая память RSS.
- Кол-во аллокаций (RubyVM::GC::Profiler, ObjectSpace).

## Оптимизации
- Минимизировать аллокации, избегать промежуточных массивов.
- Буферизация IO, стриминг там, где возможно.
- Параллелизм безопасно по чанкам (см. ADR DR-022).

### Правила
- Не нарушать детерминизм и стабильные сортировки.
- Любая оптимизация сопровождается тестом/бенчем, доказывающим отсутствие регресса.

## Защита от регрессов
- Бенчмарк‑джоб в CI (по ключевым операциям).
- Пороговые алерты (бюджет + X%).

### Пороговые значения
- Предупреждение: деградация > 10% от базовой медианы.
- Ошибка: деградация > 20%.
- База обновляется явным PR после двух последовательных улучшений ≥ 10%.
